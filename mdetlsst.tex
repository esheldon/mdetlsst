% mnras
% \documentclass[fleqn,useAMS,usenatbib]{mnras}

% apj
%\documentclass[iop, twocolappendix, appendixfloats, numberedappendix, apj]{emulateapj}
\documentclass[iop, twocolappendix, appendixfloats, numberedappendix, apj]{hackemulateapj}
%\documentclass{emulateapj}

%=====================================================================
% CUSTOM: PACKAGES, MACROS & SETTINGS
%=====================================================================
% packages for figures
\usepackage{graphicx,todonotes}

% packages for symbols
\usepackage{latexsym,amssymb}

% AMS-LaTeX package for e.g. subequations
\usepackage{amsmath,morefloats}
\usepackage[backref,breaklinks,colorlinks,citecolor=blue]{hyperref}
\usepackage{natbib,graphicx,amsmath,subfigure,color,xcolor}
%\usepackage{natbib,graphicx,amsmath,subfigure,color,xcolor,hyperref}
\usepackage{verbatim}
\usepackage{threeparttable}

\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usepgfplotslibrary{fillbetween}
\usepgfplotslibrary{groupplots}


%\usepackage{lineno}
%\linenumbers

\topmargin-1cm

\newcommand\notedo[1]{\todo[color=yellow, inline, size=\small]{To do:#1}}
\newcommand\notewrite[1]{\todo[color=orange, inline, size=\small]{To write: #1}}
\newcommand\noteask[1]{\todo[color=cyan, inline, size=\small]{To ask: #1}}
\newcommand\notecontrib[1]{\todo[color=green, inline, size=\small]{Contributors: #1}}
\newcommand{\mattodo}[1]{\textcolor{red}{[MRB TODO: \bf #1]}}
\newcommand{\esstodo}[1]{\textcolor{orange}{[ESS TODO: \bf #1]}}
\newcommand{\ess}[1]{\textcolor{blue}{[ESS: \bf #1]}}
\newcommand{\mrb}[1]{\textcolor{purple}{[MRB: \bf #1]}}


\newcommand{\vecg}{\mbox{\boldmath $g$}}
\newcommand{\vece}{\mbox{\boldmath $e$}}
\newcommand{\veck}{\mbox{\boldmath $k$}}
\newcommand{\vecQ}{\mbox{\boldmath $Q$}}
\newcommand{\vecF}{\mbox{\boldmath $F$}}
\newcommand{\vecD}{\mbox{\boldmath $D$}}
\newcommand{\matR}{\mbox{$\bf R$}}
\newcommand{\matC}{\mbox{$\bf C$}}
\newcommand{\bnab}{\boldsymbol{\nabla}}
\newcommand{\bnabg}{\boldsymbol{\nabla_g}}
\newcommand{\galsim}{\texttt{GALSIM}}
\newcommand{\ngmix}{\texttt{ngmix}}
\newcommand{\nnsim}{\texttt{nsim}}
\newcommand{\snr}{$S/N$}
\newcommand{\sn}{$S/N$}
\newcommand{\coadd}{{\rm coadd}}
\newcommand{\desreq}{$4\times 10^{-3}$}
\newcommand{\lsstreq}{$2\times 10^{-3}$}

\newcommand{\mcal}{\textsc{metacalibration}}
\newcommand{\mdet}{\textsc{metadetection}}
\newcommand{\Mcalshort}{\textsc{metacal}}
\newcommand{\Mcal}{\textsc{Metacalibration}}
\newcommand{\Mdet}{\textsc{Metadetection}}
\newcommand{\vest}{\mbox{\boldmath $e$}}
\newcommand{\est}{e}
\newcommand{\mcalR}{\mbox{\boldmath $R$}}
\newcommand{\mcalRS}{\mbox{\boldmath $R_S$}}
\newcommand{\gest}{\mbox{\boldmath $\hat \gamma$}}
\newcommand{\vecgam}{\mbox{\boldmath $\gamma$}}

\newcommand{\sx}{\textsc{Source Extractor}}

\newcommand{\bfd}{\textsc{BFD}}

\newcommand{\vonkarman}{{von K\'arm\'an}~}


%\setuphead[section][before={\testpage[2]}]

%mnras
%\title[\Mdet]{\Mdet: Mitigating Shear-dependent Object Detection Biases with \Mcal}

%\author[Sheldon et~al.]{Erin Sheldon$^1$, Matthew R. Becker$^2$,
%Niall MacCrann$^{3,4}$, Michael Jarvis$^5$
%  \\$^1$Brookhaven National Laboratory, Bldg. 510, Upton, NY 11973, USA
%  \\$^2$High Energy Physics Division, Argonne National Laboratory, Lemont, IL 60439, USA
%  \\$^3$Center for Cosmology and Astro-Particle Physics, The Ohio State University, Columbus, OH 43210, USA
%  \\$^4$Department of Physics, The Ohio State University, Columbus, OH 43210, USA
%  \\$^5$Department of Physics and Astronomy, University of Pennsylvania, Philadelphia, PA 19104, USA
%}


% apj
\shorttitle{Metadetection for Rubin}
\shortauthors{Sheldon, Becker, Armstrong}

\begin{document}
% mnrad
% \date{Draft \today}

% mnras
%\maketitle


% apj
%\title{\Mdet: Mitigating Shear-dependent Object Detection Biases with \Mcal}
\title{Metadetection for the Vera C. Rubin Observatory}

\author{Erin S. Sheldon}
\affil{Brookhaven National Laboratory, Bldg 510, Upton, New York 11973, USA}
\author{Matthew R. Becker}
\affil{High Energy Physics Division, Argonne National Laboratory, Lemont, IL 60439, USA}
\author{Michael Jarvis}
\affil{Department of Physics and Astronomy, University of Pennsylvania, Philadelphia, PA 19104, USA}
\author{Robert Armstrong}
\affil{Lawrence Livermore National Laboratory, Livermore, CA 94551, USA}


\begin{abstract}

    \Mcal\ for LSST

\end{abstract}

% \newpage
% \tableofcontents

\section{Introduction} \label{sec:intro}

\esstodo{}

\section{Simulation Features} \label{sec:simfeatures}

\esstodo{Introduce sims, coadd reference frame, galsim, explain much is same as
mdet paper and DES paper}

\subsection{Image Filters and Noise} \label{sec:simfeatures:noise}
\esstodo{descwl}

We used the WeakLensingDeblending package (TODO cite) to determine the noise
for images in each filter.  In all simulation runs we used predicted noise $n$
for the final 10 year coadd. For individual simulated epochs we re-scale the
noise appropriately, such that the noise in each epoch was $n * \sqrt{N}$.

We did not add the expected amount of background to each image, rather we
simulated errors in the background determination (see \S
\ref{sec:simfeatures:bgerr}).  After drawing all image features and adding
noise, we re-scaled the images to a common zero point of 30.

\subsection{Image World Coordinate System, Rotations and Dithers} \label{sec:simfeatures:rotdith}
\esstodo{}

Each image was simulated as a tangent plane projection of the sky onto the
image frame with the LSST camera pixel scale of 0.2 arcseconds (TODO reference).
The world coordinate system (WCS) transformation between sky and pixel
coordinates was represented as a \galsim\ \texttt{TanWCS} object.  Each
simulated WCS transformation had a random rotation applied, in order to mock up
the camera rotations used by LSST cam (TODO cite proper paper).  The center of
each image was shifted, or ``dithered'', randomly in two dimensions relative to
the center of the desired coadded image.  We choose the dithers to be a
unrealistically small, within two pixels, to minimize portions of the image
that would not overlap the final coadd.  The image size was just large enough
so that the rotated image, after dithers, would have no edge crossing the coadd
region, again to avoid waste:  coadding an image with an edge produces a
discontinuous PSF in the final coadd, so such images would be discarded.

\subsection{Point Spread Function} \label{sec:simfeatures:psf}

\mattodo{Briefly describe PS PSF and link to DES paper.}

\subsection{Stars} \label{sec:simfeatures:stars}
\esstodo{From DC2}

\subsection{Star Bleed Trails} \label{sec:simfeatures:bleeds}
\esstodo{From DC2, Jim}

\subsection{Image Saturation} \label{sec:simfeatures:sat}
\esstodo{}

\subsection{Cosmic Rays} \label{sec:simfeatures:cosmics}

\mattodo{Briefly describe and link to DES paper}

\subsection{Bad Columns} \label{sec:simfeatures:badcols}

\mattodo{Briefly describe and link to DES paper}

\subsection{Galaxies} \label{sec:simfeatures:galaxies}
\esstodo{descwl}

\subsection{Image Background} \label{sec:simfeatures:bgerr}
\esstodo{explain meant to be error in background determination}

\subsection{Layouts} \label{sec:simfeatures:layouts}
\esstodo{grid/random}

\subsection{Shear Patterns} \label{sec:simfeatures:shears}
\esstodo{fixed or random orientation}

\subsection{Coadd Cells Regions} \label{sec:simfeatures:cells}
\esstodo{}

\subsection{Features Not Simulated} \label{sec:notincluded}
\esstodo{list what and why}

\section{Image and PSF Coaddition} \label{sec:coadding}
\esstodo{explain use of DM tools}

\section{Metadetection} \label{sec:mdet}
\esstodo{brief with ref to mdet paper, and DES paper}

\subsection{Creation of Sheared Images} \label{sec:mdet:sheared}
\esstodo{use of DM data stuctures?}
\subsection{Detection} \label{sec:mdet:detect}
\esstodo{use of DM algo}
\subsection{Object Measurement} \label{sec:mdet:meas}
\esstodo{use of pgauss/wmom}

\section{Computing Requirements and Usage} \label{sec:timing}

\section{Results} \label{sec:results}

\esstodo{Establish 2nd order shear effects with grid/simple.  Demonstrate PS PSF fine for expected variation, more epochs needed for higher variation (10). Show full stars sim with cells.}

\section{Summary} \label{sec:summary}

\esstodo{}

% \input{code/mtable.tex}

% \begin{figure}
%     \includegraphics[width=\columnwidth]{code/mvals.pdf}
%     \caption{99.7\% confidence range for the multiplicative bias $m$ in
%      various simulations.  The light gray region represents the total
%      error budget for LSST, the dark gray region represents our target.
%      The dashed line is the expected bias due to second order shear effects.  Each
%      point represents the $m$ value measured in a particular simulation.  To the right
%      of each point is a code representing the simulation features used, which are
%      nostack: the LSST DM stack was not used; d: dithers; r: rotations; c: cosmic rays;
%      b: bad columns; W: realistic galaxy properties and noise using
%       the WeakLensingDeblending package; v: variable pixel scale
%      and WCS shear; p: psf $g_2 = 0.02$; RIZ: $r, i$ and $z$ bands used; LD: large dithers;
%      VPX-Y: spatially variable moffat PSF with X times the expected variation for LSST,
%      and Y epochs per band;  s: stars included at 2/sq arcminute, S: star masks and bleeds
%      included.
%     }
% \end{figure}

\begin{figure}
    \includegraphics[width=\columnwidth]{mag-hist.pdf}
    \caption{
        Star magnitudes measured in simulated $r+i+z$ combined coadds.  The
        $r-band$ magnitude limit for the input star sample is shown as a
        vertical line at 28.  The detection in the combined image is
        somewhat deeper.
    }
\end{figure}


\begin{comment}
\begin{figure}
    \includegraphics[width=\columnwidth]{code/stardens-bias.pdf}
    \caption{
        Bias as a function of minimum stellar density.  The same
        simulation was used for all points, so the errors are correlated.
    }
\end{figure}
\end{comment}



\begin{figure}
    \centering
\begin{tikzpicture}
    \begin{groupplot}[
        legend style={draw=none},
        group style={group size=1 by 2, vertical sep=0.3cm},
        xmin=0.0,
        xmax=110.0,
        width=0.9\columnwidth,
        height=0.6\columnwidth,
        minor tick num=3,
        axis on top
    ]
    \nextgroupplot[
        ylabel={$m/10^{-3}$},ymin=-2,xticklabels={,,},
        ymin=-2, ymax=2
    ]

	\addplot+[name path=A,gray!20,no markers] coordinates {
        (0.0,-1)
        (110.0,-1)
    };
    \addplot+[name path=B,gray!20,no markers] coordinates {
        (0.0,1)
        (110.0,1)
    };

    \addplot+[gray!20] fill between[of=A and B];
	\addplot+[black!80,no markers] coordinates {
        (0.0,0.0)
        (110.0,0.0)
    };

	% \addplot+[
    %     brown!60!black,mark=otimes*, mark options={fill=brown!40},
    %     error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    % ] {code/m-vs-star-density.txt};

	\addplot+[
        brown!60!black,mark=otimes*, solid, mark options={fill=brown!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/m-vs-star-density-s2n10.txt};

	\addplot+[
        teal!60!black,mark=triangle*, solid, mark options={fill=teal!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/m-vs-star-density-s2n15.txt};

	\addplot+[
        red!60!black,mark=diamond*, solid, mark options={fill=red!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/m-vs-star-density-s2n20.txt};

	\addplot+[
        blue!60!black,mark=square*, solid, mark options={fill=blue!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/m-vs-star-density-s2n25.txt};

	\addplot+[
        brown!60!black,mark=oplus*, solid, mark options={fill=yellow!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/m-vs-star-density-s2n30.txt};



    % \nextgroupplot[
    %     ymin=0.93,
    %     xlabel=Stellar Density Cut {[\#/sq arcmin]},ylabel={$\sigma_m/\sigma_m^{100}$}
    % ]

	% \addplot+[black!80,no markers] coordinates {
    %     (0.0,1.0)
    %     (110.0,1.0)
    % };

    % \addplot+[
    %     teal!60!black,mark=triangle*, mark options={fill=teal!40},
    %     error bars/.cd,y dir=both,y explicit] table[x index=0, y index=3
    % ] {code/m-vs-star-density.txt};

    \nextgroupplot[
        xlabel=Stellar Density Cut {[\#/sq arcmin]},ylabel={$\sigma_m$},
        ymin=0.6, ymax=1.1
    ]

	\addplot+[
        brown!60!black,mark=otimes*, solid, mark options={fill=brown!40} 
        ] table[x index=0, y index=2,
    ] {code/m-vs-star-density-s2n10.txt};
    \addlegendentry{$S/N > 10$}

	\addplot+[
        teal!60!black,mark=triangle*, solid, mark options={fill=teal!40}
        ] table[x index=0, y index=2,
    ] {code/m-vs-star-density-s2n15.txt};
    \addlegendentry{$S/N > 15$}

	\addplot+[
        red!60!black,mark=diamond*, solid, mark options={fill=red!40}
        ] table[x index=0, y index=2,
    ] {code/m-vs-star-density-s2n20.txt};
    \addlegendentry{$S/N > 20$}

	\addplot+[
        blue!60!black,mark=square*, solid, mark options={fill=blue!40}
        ] table[x index=0, y index=2,
    ] {code/m-vs-star-density-s2n25.txt};
    \addlegendentry{$S/N > 25$}

	\addplot+[
        brown!60!black,mark=oplus*, solid, mark options={fill=yellow!40}
        ] table[x index=0, y index=2,
    ] {code/m-vs-star-density-s2n30.txt};
    \addlegendentry{$S/N > 30$}


    \end{groupplot}
\end{tikzpicture}

    \caption{ Metadetection performance as a function of maximum stellar
    density and for different object S/N thresholds.  Simulations were run with
    the expected stellar density distribution for the full LSST 18,000 square
    degree survey, with a maximum allowed value of 100/sq. arcminute.  Stars
    bright enough to saturate were not included.  Top panel:  the
    multiplicative bias $m$ as a function of the stellar density cut and S/N
    threshold.  Objects with small measured size $T/T_{\mathrm{PSF}} < 1.2$
    were removed, where $T = \langle x^2 \rangle + \langle y^2 \rangle$ is the
    estimated psf convolved size of the object.  Bottom panel: the uncertainty
    on the mean shear as a function of the stellar density cut, for different
    S/N thresholds.  Note that many lensing probes are dominated by cosmic
    variance, which is not included in these uncertainties.  }

\end{figure}


\begin{figure}
    \centering
\begin{tikzpicture}
    \begin{axis}[
        legend style={draw=none,at={(0.97,0.5)},anchor=east},
        ylabel={$m/10^{-3}$},
        xlabel={Stellar Density $[\#/sq. arcmin]$},
        xmin=-5.0,
        xmax=190.0,
        ymin=-8,
        ymax=8,
        width=0.9\columnwidth,
        height=0.6\columnwidth,
        minor tick num=4,
        axis on top
    ]

	\addplot+[name path=A,gray!20,no markers, forget plot] coordinates {
        (0.0,-1)
        (110.0,-1)
    };
    \addplot+[name path=B,gray!20,no markers, forget plot] coordinates {
        (0.0,1)
        (110.0,1)
    };

    \addplot+[gray!20, forget plot] fill between[of=A and B];
	\addplot+[black!80,no markers, forget plot] coordinates {
        (0.0,0.0)
        (110.0,0.0)
    };

	\addplot+[
        brown!60!black,mark=otimes*, solid, mark options={fill=brown!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/mc-results-run-drsBMWRIZ-v1/m-vs-star-density-s2n10.txt};
    \addlegendentry{$S/N > 10$}

	\addplot+[
        teal!60!black,mark=triangle*, solid, mark options={fill=teal!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/mc-results-run-drsBMWRIZ-v1/m-vs-star-density-s2n15.txt};
    \addlegendentry{$S/N > 15$}

	\addplot+[
        red!60!black,mark=diamond*, solid, mark options={fill=red!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/mc-results-run-drsBMWRIZ-v1/m-vs-star-density-s2n20.txt};
    \addlegendentry{$S/N > 20$}

	\addplot+[
        blue!60!black,mark=square*, solid, mark options={fill=blue!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/mc-results-run-drsBMWRIZ-v1/m-vs-star-density-s2n25.txt};
    \addlegendentry{$S/N > 25$}

	\addplot+[
        brown!60!black,mark=oplus*, solid, mark options={fill=yellow!40},
        error bars/.cd,y dir=both,y explicit] table[x index=0, y index=1, y error index=2
    ] {code/mc-results-run-drsBMWRIZ-v1/m-vs-star-density-s2n30.txt};
    \addlegendentry{$S/N > 30$}


    \end{axis}

\end{tikzpicture}

    \caption{ Metadetection multiplicative bias as a function of maximum
    stellar density and for different object S/N thresholds.  Simulations were
    run with the expected stellar density distribution for the full LSST 18,000
    square degree survey, with a maximum allowed value of 100/sq. arcminute.
    Stars were simulated as Moffat profiles and were allowed to saturate, with
    simulated bleed trails.  A circular mask was used for saturates stars and
    this area was interpolated.  Error bars are 99.7\% confidence regions.
    Objects with small measured size $T/T_{\mathrm{PSF}} < 1.2$ were removed,
    where $T = \langle x^2 \rangle + \langle y^2 \rangle$ is the estimated psf
    convolved size of the object.}

\end{figure}





\begin{figure}
    \centering
\begin{tikzpicture}

	\begin{axis}[
        legend style={draw=none},
        xlabel=min S/N,
        ylabel={$\sigma/\sigma_{\mathrm{no~stars}}$},
        xmin=5.0,
        xmax=50.0,
        ymin=1.1,
        ymax=1.225,
        width=0.9\columnwidth,
        height=0.6\columnwidth,
        minor tick num=3,
        axis on top
	]

	%\addplot+[black,no markers] coordinates {
    %    (0.0,1.0)
    %    (110.0,1.0)
    %};


        %\addplot+[brown!60!black,mark=otimes*, solid, mark options={fill=brown!40}]
        %    table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut010.txt};
        %\addlegendentry{$d < 10$}

        \addplot+[teal!60!black,mark=triangle*, solid, mark options={fill=teal!40}]
            table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut020.txt};
        \addlegendentry{$d < 20$}

        \addplot+[red!60!black,mark=diamond*, solid, mark options={fill=red!40}]
            table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut040.txt};
        \addlegendentry{$d < 40$}
        \addplot+[blue!60!black,mark=square*, solid, mark options={fill=blue!40}]
            table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut060.txt};
        \addlegendentry{$d < 60$}
        \addplot+[brown!60!black,mark=oplus*, solid, mark options={fill=yellow!40}]
            table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut080.txt};
        \addlegendentry{$d < 80$}
        \addplot+[orange!60!black,mark=*, solid, mark options={fill=orange!40}]
            table[x index=0, y index=1] {code/mc-results-6700/noise-ratio-dcut100.txt};
        \addlegendentry{$d < 100$}


	\end{axis}
\end{tikzpicture}

    \caption{Increased noise in the recovered shear when stars are present in
    the simulation, compared to a simulation without stars, as a function of
    the minimum signal-to-noise ratio and maximum stellar density.  The stellar
    density was drawn from the expected distribution for the full LSST 18,000
    square degree survey, including regions with density as high as 100 per
    square arcmin.  Stars were allowed to saturate, and a fixed size star mask
    was used, but no bleed trails were present.  To select galaxies, only
    objects with size $T/T_{\mathrm{PSF}} > 1.2$ were used, where $T = \langle
    x^2 \rangle + \langle y^2 \rangle$ is the estimated psf convolved size of
    the object.  The lowest absolute noise is for $S/N > 10$ and a liberal cut
    on stellar density at $d < 60$, which also results in the smallest
    increase in noise relative to a simulation with no stars.  Note that many
    lensing probes are dominated by cosmic variance, which is not included in
    these uncertainties.  }

\end{figure}



\section*{Acknowledgments}

ES is supported by DOE grant DE-AC02-98CH10886, and MB is supported by DOE
grant DE-AC02-06CH11357.  RM is supported by the US Department of Energy Cosmic
Frontier program, grant DE-SC0010118.


%\bibliographystyle{mnras}
%\bibliography{references}
%\bibliography{apj-jour,references}
%\bibliographystyle{apj}
\bibliographystyle{aasjournal}
\bibliography{references}

\end{document}
